# ==============================================================================
# WORKFLOW: Deploy Sovereign Orchestrator
# TRIGGER: On push to 'main' branch when files in 'cloudformation/orchestrator/' change.
# PERMISSIONS: Requires OIDC (id-token: write) to assume the AWS Role safely.
# ==============================================================================

name: Deploy Sovereign Orchestrator

on:
  push:
    branches:
      - main
    paths:
      - 'cloudformation/orchestrator/**' # Only run if orchestrator code is updated

permissions:
  id-token: write # Mandatory for OIDC authentication
  contents: read  # Mandatory for checking out the repository code

jobs:
  Deploy-Orchestrator:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------------------
      # STEP 1: Pull the latest code from the repository
      # ------------------------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # STEP 2: Authenticate with AWS using the Sovereign OIDC Bridge
      # ------------------------------------------------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }} # The ARN from your CloudFormation Output
          aws-region: ap-southeast-2                  # Sydney Region (Sovereign Data Residency)

      # ------------------------------------------------------------------------
      # STEP 3: Deploy the Master Deny SCP via CloudFormation
      # COMPLIANCE: Automates the "Policy-as-Code" deployment for ISM/E8.
      # ------------------------------------------------------------------------
      - name: Deploy CloudFormation Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/orchestrator/e8-guardrails.yaml \
            --stack-name Sovereign-Orchestrator \
            --parameter-overrides RootOUID=${{ secrets.AWS_ROOT_OU_ID }} \
            --capabilities CAPABILITY_IAM
